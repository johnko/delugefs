#!/bin/sh

ZFS_DATASET="tank/delugefs"
CLUSTER_ID="${1}"
shift
if [ "x" != "x${1}" ]; then
    ZFS_DATASET="${1}"
    shift
fi
if [ "x--create" == "x${1}" ]; then
    CREATE="--create --btport 6881"
    shift
fi
PYSCRIPT=/usr/home/delugefs/delugefs.py

service mdnsd onestatus > /dev/null 2> /dev/null || service mdnsd onestart > /dev/null 2> /dev/null

if ! kldstat | grep fuse > /dev/null 2> /dev/null ; then
    kldload fuse
    if ! kldstat | grep fuse > /dev/null 2> /dev/null ; then
        echo "ERROR: can't load fuse"
        exit 1
    fi
fi
sysctl vfs.usermount=1 > /dev/null 2> /dev/null

sysctl vfs.fuse.mmap_enable=1 > /dev/null 2> /dev/null # has to be 1 so cp doens't error Bad Address
sysctl vfs.fuse.data_cache_enable=1 > /dev/null 2> /dev/null # has to be 1 so cp doens't error Bad Address
# invalidate fuse data cache to force reads (especially since the torrent file will change without telling FUSE)
sysctl vfs.fuse.data_cache_invalidate=1 > /dev/null 2> /dev/null
# invalidate the lookup cache because files can be removed without telling FUSE
sysctl vfs.fuse.lookup_cache_enable=1 > /dev/null 2> /dev/null

if ! zfs list ${ZFS_DATASET} > /dev/null 2> /dev/null ; then
    zfs create ${ZFS_DATASET}
    if ! zfs list ${ZFS_DATASET} > /dev/null 2> /dev/null ; then
        echo "ERROR: can't find zfs ${ZFS_DATASET}"
        exit 1
    fi
fi

if ! id 1007 > /dev/null 2> /dev/null ; then
    ### Add delugefs user
    echo "delugefs:1007::::::/usr/home/delugefs:/bin/csh:" | adduser -w no -f -
    pw groupmod operator -m delugefs
    if ! id 1007 > /dev/null 2> /dev/null ; then
        echo "ERROR: delugefs user not exist"
        exit 1
    fi
fi


if [ ! -d /usr/home/delugefs ]; then
    install -d -m 755 -o delugefs /usr/home/delugefs
fi
if [ ! -e /usr/home/delugefs/.ssh/id_ed25519 ]; then
    su -l delugefs -c "ssh-keygen -N '' -t ed25519 -f ~/.ssh/id_ed25519"
fi
install -m 644 -o delugefs ${HOME}/git/delugefs/src/fuse.py ${PYSCRIPT%/*}/fuse.py
install -m 755 -o delugefs ${HOME}/git/delugefs/src/delugefs.py ${PYSCRIPT}
install -m 755 -o delugefs ${HOME}/git/delugefs/bin/delugefs-shell ${PYSCRIPT%/*}/delugefs-shell
chown delugefs /${ZFS_DATASET}


if ! mount | grep "/tank/${CLUSTER_ID}" > /dev/null 2> /dev/null ; then
    MOUNT="--mount /tank/${CLUSTER_ID}"
    install -d -m 755 -o delugefs /tank/${CLUSTER_ID}
fi

su -l delugefs -c "${PYSCRIPT} \
    ${CREATE} \
    ${MOUNT} \
    --cluster ${CLUSTER_ID} \
    --root /${ZFS_DATASET}/.${CLUSTER_ID}db $*"

# reminder to add peers to /usr/home/delugefs/.ssh/known_hosts
# and peer pubkeys to /usr/home/delugefs/.ssh/authorized_keys2
