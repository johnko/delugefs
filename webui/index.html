<!DOCTYPE html>
<html>
    <head>
        <title>DelugeFS - Status</title>
        <meta charset="UTF-8">
    </head>
    <body class="theme-atom">
        <div class="nav">
            <h1>DelugeFS <span id="version"></span> - Status</h1>
        </div>
        <div class="container border float-left">
            <h2>This Node Info</h2>
            <div class="table">
                <div class="label">
                    Hostname
                </div>
                <div id="hostname" class="string"></div>
                <div class="label">
                    BT Port
                </div>
                <div id="btport" class="number"></div>
                <div class="label">
                    WebUI Host
                </div>
                <div id="webip" class="string"></div>
                <div class="label">
                    WebUI Port
                </div>
                <div id="webport" class="number"></div>
                <div class="label">
                    WebUI Directory
                </div>
                <div id="webdir" class="path"></div>
                <div class="label">
                    Lazy?
                </div>
                <div id="lazy" class="string"></div>
                <div class="label">
                    Disk Root
                </div>
                <div id="root" class="path"></div>
                <div class="label">
                    Disk Mount
                </div>
                <div id="mount" class="path"></div>
                <div class="label">
                    Disk Free Space
                </div>
                <div id="freespace" class="number"></div>
                <div class="label">
                    Datacenter
                </div>
                <div id="datacenter" class="string"></div>
            </div>
            <div class="clear">
                <h3>Chart / Graph</h3>
                <div class="data">
                    Todo...
                </div>
            </div>
        </div>
        <div class="container border float-left">
            <h2>Cluster Info</h2>
            <div class="table">
                <div class="label">
                    Cluster Name
                </div>
                <div id="name" class="string"></div>
                <div class="label">
                    Disk Free Space
                </div>
                <div id="cluster_freespace" class="number"></div>
            </div>
            <div class="clear">
                <h3>Disk Space Pie Chart</h3>
                <div class="data">
                    Todo...
                </div>
            </div>
        </div>
        <div class="container border float-left">
            <h2>Peers<span id="peercount"></span></h2>
                <!--div class="form">
                    <h3>Add A New Peer</h3>
                    <form>
                        <input type="text" value="Host (Name / IP)"/>
                        <button>Add Peer</button>
                    </form>
                </div-->
            <div class="data" id="peers"></div>
        </div>
        <div class="container border float-left">
            <h2>Torrent Peers<span id="btpeercount"></span></h2>
                <!--div class="form">
                    <h3>Add A Torrent Peer</h3>
                    <form>
                        <input type="text" value="Host (Name / IP)"/>
                        <input class="port" type="text" value="BT Port"/>
                        <button>Add Peer</button>
                    </form>
                </div-->
            <div class="data" id="btpeers"></div>
        </div>
        <div class="container border float-left">
            <h2>DHT Routers</h2>
                <!--div class="form">
                    <h3>Add A DHT Router</h3>
                    <form>
                        <input type="text" value="Host (Name / IP)"/>
                        <input class="port" type="text" value="DHT Port"/>
                        <button>Add Router</button>
                    </form>
                </div-->
            <div class="data">
                Todo...
            </div>
        </div>
        <div class="clear container border float-left">
            <h2>Active<span id="activecount"></span></h2>
            <button id="toggleactive" class="toggle">x</button>
            <div class="data" id="activetorrents"></div>
        </div>
        <div class="container border float-left">
            <h2>Queued<span id="qingcount"></span></h2>
            <button id="toggleqing" class="toggle">x</button>
            <div class="data" id="qingtorrents"></div>
        </div>
        <div class="container border float-left">
            <h2>Sleeping<span id="sleepingcount"></span></h2>
            <button id="togglesleeping" class="toggle">x</button>
            <div class="data" id="sleepingtorrents"></div>
        </div>

        <style type="text/css">
            body.theme-atom {
                background-color: #22252B;
                color: #ADB2BF;
            }
            body.theme-atom .border {
                border: 1px solid #181a1f;
                border-radius: 3px;
            }
            body.theme-atom input {
                border: 2px solid #181a1f;
                border-radius: 3px;
                color: #696E79;
                font-size: 1em;
                font-family: monospace;
            }
            body.theme-atom input:focus {
                border: 2px solid #6A84FE;
                color: #D8DAE0;
            }
            body.theme-atom button {
                background-color: #2F343D;
                border: 1px solid #181a1f;
                border-radius: 3px;
                color: #6E7480;
                font-size: 1em;
                font-family: monospace;
            }
            body.theme-atom button:hover, body.theme-atom button:active {
                background-color: #373C47;
                border: 1px solid #181a1f;
                color: #99A1AF;
            }
            body.theme-atom .nav {
                border-bottom: 1px solid #3B4048;
            }
            body.theme-atom .container {
                background-color: #292C34;
            }
            body.theme-atom h1 {
                font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
                font-size: 1em;
                font-weight: 100;
                letter-spacing: 0.05em;
            }
            body.theme-atom h2 {
                border-bottom: 1px dashed #3B4048;
                font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
                font-size: 1.5em;
                font-weight: 100;
                letter-spacing: 0.05em;
            }
            body.theme-atom h3 {
                font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
                font-size: 1em;
                font-weight: 100;
                letter-spacing: 0.05em;
            }
            body.theme-atom .data {
                font-size: 1em;
                font-family: monospace;
            }
            body.theme-atom div.table div {
                font-family: "Lucida Grande", Arial, sans-serif;
                font-size: 0.8em;
                font-weight: 300;
                letter-spacing: 0.05em;
            }
            body.theme-atom div.table div.label {
                color: #4C5062;
            }
            body.theme-atom .number {
                color: #CA9B63;
            }
            body.theme-atom .path {
                color: #61B6C1;
            }
            body.theme-atom .string {
                color: #9Ac579;
            }
            body.theme-atom input {
                background-color: #1C1D23;
            }
            body.theme-atom .warn {
                color: #CA5D61;
            }
            body.theme-atom .hilite {
                color: #C678DD;
            }
            body.theme-atom th {
                color: #4C5062;
                font-family: "Lucida Grande", Arial, sans-serif;
                font-size: 0.8em;
                font-weight: 300;
                letter-spacing: 0.05em;
            }
            body.theme-atom .progress {
                border: 1px solid #61B6C1;
                border-radius: 3px;
            }
            body.theme-atom .progress .bar {
                background-color: #61B6C1;
                font-size: 0.4em;
                height: 100%;
            }
        </style>
        <style type="text/css">
            body {
                margin: 0 1em 0 0;
                padding: 0;
            }
            .nav {
                margin: 0px 0px 1em 1em;
                padding: 0.5em;
            }
            .container {
                margin: 0px 0px 1em 1em;
                padding: 0.5em;
            }
            .float-left {
                float: left;
            }
            .clear {
                clear: both;
            }
            h1 {
                margin: 0 0 0 0;
            }
            h2 {
                margin: 0 0 1em 0;
            }
            div.table div {
                float: left;
                margin: 0 0 1em 1em;
            }
            div.table div.label {
                clear: both;
                margin: 0 0 0 0;
            }
            .form h3 {
                margin: 0;
            }
            .form {
                margin: 0 0 1em 0;
            }
            input, button {
                padding: 0.3em;
            }
            input.port {
                width: 5em;
            }
            td, th {
                padding: 0.5em 1em;
                white-space: nowrap;
            }
            td.number {
                text-align: right;
            }
            .toggle {
                float: right;
            }
            .data table td a {
                color: inherit;
                text-decoration: none;
            }
            .progress {
                height: 12px;
                width: 50px;
            }
        </style>
        <script type="text/javascript" src="/js/jquery-2.1.4.js"></script>
        <script type="text/javascript">
            id_to_populate = [
                "btport",
                "webip",
                "webport",
                "webdir",
                "gitlog",
                "lazy",
                "root",
                "mount",
                "name",
                "version",
                "hostname",
                "freespace",
                "activetorrents",
                "peers"
            ];
            function refresh_info() {
                $.ajax({
                    url: "/api/v2/json/all",
                    dataType: "json"
                }).success(function(data) {
                    $.each(data, function(k,v) {
                        set_info('#'+k, v);
                    });
                });
                setTimeout(function() { refresh_info(); }, 5000); // about 5 seconds
            }
            $(document).ready(function() {
                refresh_info();
                $('#toggleactive').click(function() {
                    if ($('#toggleactive').html()=='x') {
                        $('#toggleactive').html('+');
                        $('#activetorrents').hide();
                    } else {
                        $('#toggleactive').html('x')
                        $('#activetorrents').show();
                    }
                });
                $('#toggleqing').click(function() {
                    if ($('#toggleqing').html()=='x') {
                        $('#toggleqing').html('+');
                        $('#qingtorrents').hide();
                    } else {
                        $('#toggleqing').html('x')
                        $('#qingtorrents').show();
                    }
                });
                $('#togglesleeping').click(function() {
                    if ($('#togglesleeping').html()=='x') {
                        $('#togglesleeping').html('+');
                        $('#sleepingtorrents').hide();
                    } else {
                        $('#togglesleeping').html('x')
                        $('#sleepingtorrents').show();
                    }
                });
                $('#toggleqing').click();
                $('#togglesleeping').click();
            });
            function set_info(id, val) {
                if ($.isArray(val)) {
                    if (id=='#btpeers') {
                        btpeercount = 0;
                        btpeertable = $('<table>');
                        btpeertable.append('<tr>\
                            <th>IP</th><th>BT</th>\
                        </tr>');
                        $.each(val, function(k,v) {
                            row = $('<tr>');
                            row.append($('<td>'+v['ip']+'</td>'));
                            row.append($('<td class="number">'+v['bt_port']+'</td>'));
                            btpeertable.append(row);
                            btpeercount++;
                        });
                        $('#btpeers').empty().append(btpeertable);
                        $('#btpeercount').empty().append('<span class="number"> '+btpeercount+'</span>');
                    } else if (id=='#peers') {
                        peercount = 0;
                        peertable = $('<table>');
                        peertable.append('<tr>\
                            <th>Host</th><th>IP</th><th>BT</th>\
                        </tr>');
                        $.each(val, function(k,v) {
                            btport = '';
                            row = $('<tr title="'+v['service_name']+'">');
                            row.append($('<td>'+v['host']+'</td>'));
                            row.append($('<td>'+v['addr']+'</td>'));
                            if (v['bt_port']!='None') btport = v['bt_port'];
                            row.append($('<td class="number">'+btport+'</td>'));
                            peertable.append(row);
                            peercount++;
                        });
                        $(id).empty().append(peertable);
                        $('#peercount').empty().append('<span class="number"> '+peercount+'</span>');
                    } else if (id=='#activetorrents') {
                        qingcount = 0;
                        qingtable = $('<table>');
                        qingtable.append('<tr>\
                            <th>Chunk</th><th>Progress</th><th>State</th>\
                        </tr>');
                        sleepingcount = 0;
                        sleepingtable = $('<table>');
                        sleepingtable.append('<tr>\
                            <th>Chunk</th>\
                        </tr>');
                        activecount = 0;
                        activetable = $('<table>');
                        activetable.append('<tr>\
                            <th>Chunk</th><th>Progress</th><th>Down</th><th>Up</th><th>Peers</th><th>State</th>\
                        </tr>');
                        $.each(val, function(k,v) {
                            progress = '';
                            down = '';
                            up = '';
                            peers = '';
                            state = '';
                            patharray = v['path'].split('/');
                            filename = patharray[patharray.length-1];
                            row = $('<tr title="'+v['hash_name']+'">');

                            row.append($('<td>'+filename+'</td>'));

                            progress = '<div class="progress"><div class="bar" style="width:'+v['progress']+'%;">&nbsp;</div></div>';

                            if (v['down']!=0) down = v['down'];

                            if (v['up']!=0) up = v['up'];

                            if (v['peers']!=0) peers = v['peers'];

                            if (v['state']=='downloading') state = 'd';
                            else if (v['state']=='seeding') state = '';
                            else state = v['state'];

                            if ((v['down']==0)&&(v['up']==0)&&(v['peers']==0)&&(v['state']=='seeding')) {
                                /*
                                row.append($('<td>'+progress+'</td>'));
                                row.append($('<td class="number">'+down+'</td>'));
                                row.append($('<td class="number">'+up+'</td>'));
                                row.append($('<td class="number">'+peers+'</td>'));
                                row.append($('<td>'+state+'</td>'));
                                */
                                sleepingtable.append(row);
                                sleepingcount++;
                            } else if ((v['down']==0)&&(v['up']==0)&&(v['peers']==0)&&(v['state']!='seeding')) {
                                row.append($('<td>'+progress+'</td>'));
                                /*
                                row.append($('<td class="number">'+down+'</td>'));
                                row.append($('<td class="number">'+up+'</td>'));
                                row.append($('<td class="number">'+peers+'</td>'));
                                */
                                row.append($('<td>'+state+'</td>'));
                                qingtable.append(row);
                                qingcount++;
                            } else {
                                row.append($('<td>'+progress+'</td>'));
                                row.append($('<td class="number">'+down+'</td>'));
                                row.append($('<td class="number">'+up+'</td>'));
                                row.append($('<td class="number">'+peers+'</td>'));
                                row.append($('<td>'+state+'</td>'));
                                activetable.append(row);
                                activecount++;
                            }
                        });
                        $(id).empty().append(activetable);
                        $('#activecount').empty().append('<span class="number"> '+activecount+'</span>');
                        $('#qingtorrents').empty().append(qingtable);
                        $('#qingcount').empty().append('<span class="number"> '+qingcount+'</span>');
                        $('#sleepingtorrents').empty().append(sleepingtable);
                        $('#sleepingcount').empty().append('<span class="number"> '+sleepingcount+'</span>');
                    }
                } else if ($.isXMLDoc(val)) {
                    // nothing
                } else {
                    var strval = '<span>'+val+'</span>';
                    if ($(id).html()!=strval) {
                        el = $(strval);
                        $(id).empty().append(el);
                    }
                }
            }
        </script>
    </body>
</html>
